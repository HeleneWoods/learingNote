# 概览

## 资源

Web内容都存储在Web服务器上，

Web服务器是Web资源的宿主，

Web资源是Web内容的源头。

Web资源里的文件可以包含任意内容：文本文件、HTML文件、微软的Word文件、JPEG图片文件、视频文件等静态文件。

也可以是根据需要生成内容的软件程序。这种动态内容可以根据你的身份、所请求的信息或每天的不同时段产生内容。

### 媒体内容

HTTP给每种要通过Web传输的对象都打上了名为MIME类型的数据格式标签。也就是`Content-type`的值。

MIME类型是一种文本标记：

* `text/html`--标记HTML格式的文本文档
* `text/plain`--标记普通的ASCII文本文档
* `image/jpeg`，`image/gif`--标记两种格式的图片

### URI

URI，统一资源标识符，是服务器资源名。

URL和URN是它的两种形式。

### URL

URL，统一资源定位符，是资源标识符最常见的形式。

描述了一台特定服务器上某资源的特定位置。

比如：`http://www.joes-hardware.com/specials/saw-blade.gif`

-  `HTTP`指http协议
- `www.joes-hardware.com` 是服务器域名
- `/specials/saw-blade.gif` 是资源名

由上能看出，大部分URL都遵循一种标准格式，包括三部分：

- 方案，说明了访问资源所使用的协议类型
- 因特网地址，说明了服务的地址
- 资源，指Web服务上的某个资源

### URN

统一资源名，URI的第二种形式。作为特定内容的唯一名称使用，与目前的资源所在地无关。并未大范围使用。

## 事务

HTTP事务是由一条从客户端发往服务器的请求命令和一个从服务器发回客户端的响应结果组成的。

这种通信是通过名为`HTTP报文`的格式化数据块进行的。

### 方法

HTTP的请求命令又称为HTTP方法。

没跳请求报文都包含一个方法，用来告诉服务器要执行什么动作。

常见的五种方法：

- GET--从服务器向客户端发送命名资源（也就是想服务器请求资源）
- POST--将客户端数据发送到一个服务器网关应用程序
- PUT--将来自客户端的数据存储到一个命名的服务器资源中去
- DELETE--从服务器中删除命名资源
- HEAD--仅发送命名资源响应中的HTTP首部

### 状态码

每条HTTP响应报文返回时都会携带一个状态码，

用来告知客户端请求是否成功，或者是否需要采取其他动作。

常见状态码：

- 200--文档正确返回
- 302--重定向，到其他地方去获取资源
- 404--没找到，无法找到这个资源

## 报文

HTTP报文都是纯文本，不是二进制代码。

分为请求报文和响应报文。

报文包括以下三个部分：

- 起始行
  - 在请求报文中说明要做什么
  - 在响应报文中说明出现了什么情况
- 首部字段
  - 每个首部字段都是一个名值对
  - 请求首部可以包括：接受什么格式的文件，接受哪种语言
  - 响应首部可以包括：响应日期、响应内容的长度、响应内容的类型
- 主体
  - 包含了所有类型的数据
  - 请求主体中包含了发送给Web服务器的数据
  - 响应主体中包含了要返回给客户端的数据

## 连接

HTTP是个应用层协议，无需操心网络通信的具体细节。

联网的细节都交给了因特网传输协议TCP/IP。

TCP提供了：

- 无差错的数据传输
- 按序传输（数据总是按照发送顺序到达）
- 未分段的数据流（可以在任意时刻，以任意尺寸将数据发送出去）

HTTP网络协议栈（依次从上到下）：

- HTTP--应用层
- TCP--传输层
- IP--网络层
- 网络特有的链路接口--数据链路层
- 物理网络硬件--物理层

HTTP协议位于TCP的上层，HTTP使用TCP来传输其报文数据。

### 连接、IP地址及端口号

在HTTP客户端想服务器发送报文之前，需要用网络协议*地址*和*端口号*在客户端和服务器之前建立一条TCP/IP连接。

我们可以通过URL获取IP地址和端口号。

URL又分为两种：

- `http://207.200.83.28:80/index.html`

  这是机器的IP地址，IP是207.200.83.28，端口号是80

- `http://www.netscape.com:80/index/html`

  这是文本形式的域名，是IP地址比较人性化的别称。可以通过DNS（也就是域名服务）的机制将主机名转成IP地址。

如果没有设置端口号，可以将其默认为80.

客户端通过HTTP获取服务端资源的步骤：

- 浏览器从URL中解析出服务器的主机名
- 浏览器将服务器的主机名转换成服务器的IP地址
- 浏览器将端口号从URL中解析出来
- 浏览器建立一条与Web服务器的TCP连接
- 浏览器向服务器发送一条HTTP请求报文
- 服务器向浏览器回送一条HTTP响应报文
- 关闭连接，浏览器显示文档

# URL与资源

URL其实就是URI的子集。

URL可以通过HTTP之外的其它协议来访问资源，比如：mailto, ftp, rtsp。

但不论是什么协议，URL都有一种统一的资源命名方式。结构是：方案+位置+路径。

## URL语法

由于资源可以通过不同的方案来访问，因此URL语法也会有所不同。

不过大多数方案的URL语法都建立在由9部分构成的通用格式上：

- 方案--使用哪种协议获取服务器资源；
- 用户--某些方案访问资源时需要用户名，比如FTP服务器；
- 密码--用户名后面可能要包含密码，中间由冒号分割；
- 主机--服务器主机名或IP地址；
- 端口--服务器监听的端口号，默认为80；
- 路径--服务器上资源的本地名，由一个斜（/）与前面的URL组件分隔开；URL路径可以分为若干个端，每段都可以有其特有的参数组件；
- 参数--很多方案单通过主机名和路径是无法获取资源的，还需要更多的参数信息。参数为名值对，名值对之间用等号（=）连接，参数之间以及与路径的其余部分之间用分号（；）分隔；
- 查询--比如数据库、搜索引擎可以通过提问或查询来缩小请求资源的范围，这就需要用到这个组件传递参数，以激活应用程序，依然是名值对形式，用字符“？”与其余部分分隔开；
- 片段--一部分资源的名字，由于服务器只处理整个对象，所以客户端不会将片段传送给服务器，仅在客户端内部使用，可以定位到比如一个文章的某一个段落。通过字符“#”与其余部分分隔开。

# HTTP报文

 ## 报文流

报文在客户端、服务器和代理之间流动，就称为报文流，

流入、流出、上游、下游都是用来描述报文方向的术语。

报文流入源端服务，工作完成之后，会流回用户的Agent代理中。

### 报文向下游流动

所有报文都是向下游流动的，报文的发送者都在接收者的上游。

客户端（请求） -> 代理1 -> 代理2 -> 代理3 -> 服务器（响应） -> 代理3 -> 代理2 -> 代理1 -> 客户端

通过上面的流程可以看出，对于请求报文，代理1在代理3的上游，

但对于响应报文，代理1处于代理3的下游。

## 报文的组成部分

报文主要由三部分组成：对报文进行描述的起始行、包含属性的首部块，以及可选的、包含数据的主体部分。

### 起始行

1、请求行

请求报文的起始行，就叫请求行。请求报文请求服务器对资源进行一些操作。

请求行包含了一个方法、一个请求URL和HTTP版本号。

2、响应行

响应报文的起始行，就是响应行。响应报文承载了状态信息和操作产生的所有结果数据。

响应行包含了响应报文使用的HTTP版本、数字状态码，以及描述操作状态的文本形式的原因短语。

3、方法

请求的起始行以方法作为开始，方法用来告诉服务器要做什么。

服务器的请求方法不仅限于常用的那几种HTTP方法，还可能实现一些自己的请求方法，这种对HTTP规范的扩展称为扩展方法。

4、状态码

状态码用来告诉客户端，发生了什么事情。

- 200-299之间的状态码表示成功；

- 300-399之间的状态码表示资源已被移走；

- 400-499之间的状态码表示客户端的请求出错了；

- 500-599之间的状态码表示服务器出错了。

5、原因短语

这是响应行中的最后一个组件。为状态码提供了文本形式的解释，是状态码的可读版本。

6、版本号

以`HTTP/x.y`的形式出现在请求和响应报文的起始行。将自己所遵循的协议版本告知对方。

### 首部

起始行后面的就是零个、一个或多个HTTP首部字段。

这是些附加信息，是一些名值对的列表。

首部分为以下几类：

- 通用首部--可以出现在请求报文中，也可以出现在响应报文中
- 请求首部--提供有关请求的信息
- 响应首部--提供有关响应的信息
- 实体首部--描述主体的长度和内容，或者资源本身
- 扩展首部--规范中没有定义的新首部

### 实体的主体部分

这是可选的部分，就是HTTP要传输的内容。

可以承载多类型的数字数据：图片、视频、HTML文档、电子邮件等等。

### 版本0.9的报文

HTTP版本0.9是HTTP协议的早期版本，是所有报文的鼻祖。

其请求中只包含方法和请求URL，响应中只包含实体。

它没有版本信息，没有状态码、原因短语，也没有首部。

## 方法

### 安全方法

GET和HEAD被认为是安全方法，因为HTTP请求不会再服务器上产生什么动作。

## 状态码

### 100~199 信息性状态码

- 100--Continue，说明收到了请求的初始部分，请客户端继续。
- 101--Switch Protocols，说明服务器正在根据客户端的指定，将协议切换成Update首部所列的协议。

### 200~299 成功状态码

- 200--OK，请求没有问题，实体的主体部分包含了所有请求的资源；
- 201--Created，用于创建服务器对象的请求（比如PUT）；
- 202--Accepted，请求已被接受，但服务器还未对其执行任何动作；
- 203--Non-Authoritative Information，实体首部包含的信息不是来自于源端服务器，而是来自资源的一份副本。
- 204--No-Content，响应报文中包含若干首部和一个状态行，但没有实体的主体部分。
- 205--Reset Content，另一个主要用于浏览器的代码，负责告诉浏览器清除当前页面中的所有HTML表单元素。
- 206--Partial Content，成功执行了一个部分或Range请求。

### 300~399 重定向状态码

重定向状态码要么告知客户端使用替代位置来访问他们所感兴趣的资源，要么就提供一个替代的响应而不是资源的内容。

如果资源已被移动，可以发送一个重定向状态码和一个可选的Location首部来告知客户端资源已被移走，以及现在可以在哪里找到它。

- 300--Multiple Choices，客户端请求一个实际指向多个资源的URL时会返回这个状态码，比如服务器上有某个HTML文档的英语和法语版本。
- 301--Moved Permanently，在请求的URL已被移除时使用。
- 302--Found，与301状态码类似，但是客户端应该使用Location首部给出的URL来临时定位资源。
- 303--See Other，告知客户端应该用另一个URL来获取资源。
- 304--Not Modified，客户端可以通过所包含的请求首部，使其请求变成有条件的。带有这个状态码的响应不应该包含实体的主体部分。
- 305--Use Proxy，用来说明必须通过一个代理来访问资源；代理的位置由Location首部给出。
- 307--Temporary Redirect，与301类似，但是客户端应该使用Location首部给出的URL来临时定位资源。

### 400~499 客户端错误状态代码

- 400--Bad Request，用于告知客户端发送了一个错误的请求。
- 401--Unauthorized，与适当的首部一同返回，在这些首部中请求客户端在获取对资源的访问权之前，对自己进行认证。
- 403--Forbidden，用于说明请求被服务器拒绝了。
- 404--Not Found，服务器无法找到所请求的URL。
- 405--Method Not Allowed，发起的请求中带有请求的URL不支持的方法。应该在响应中包含Allow首部，以告知客户端所请求的资源可以使用哪些方法。
- 406--Not Accepted，客户端可以指定参数来说明他们愿意接收什么类型的实体。服务器没有与客户端可接受的URL相匹配的资源时，使用此代码 。
- 407--Proxy Authentication Required，与401状态码类似，当用于要求对资源进行认证的代理服务器。
- 408--Request Timeout，如果客户端完成请求所花的时间太长，服务器可以回送次状态码并关闭连接。
- 409--Conflict，用于说明请求可能在资源上引发的一些冲突。
- 410--Gone，与404类似，只是服务器曾经拥有过次资源。
- 411--Length Required，服务器要求在请求报文中包含Content-Length首部时使用。
- 417--Expectation Failed，请求的Expect请求首部包含了一个期望，但服务器无法满足此期望时，使用此状态码。

### 500~599 服务器错误状态码

- 500--Internal Server Error，服务器遇到一个妨碍它为请求提供服务的错误时，使用此状态码。
- 501--Not Implemented，客户端发起的请求超出服务器的能力范围时，使用此状态码。
- 502--Bad Gateway，作为代理或网关使用的服务器从请求响应链的下一条链路上收到了一条伪响应时，使用此状态码。
- 503--Service Unavailable，用来说明服务器现在无法提供服务，但将来可以。
- 504--Gateway Timeout，与状态408类似，只是这里的响应来自一个网关或代理，它们在等待另一个服务器对其请求进行相应时超时了。
- 505--HTTP Version Not Supported，服务器收到的请求使用了它无法或不愿支持的协议版本。

## 首部

首部和方法配合工作，共同决定了客户端和服务器能做什么事情。

首部分为五个主要类型：

- 通用首部
  - 客户端和服务器都可以使用的通用首部。比如Date首部，说明构建报文的时间和日期
- 请求首部
  - 请求报文特有的首部，为服务器提供了一些额外信息，比如Accept首部，告知服务器客户端会接受与其请求相符的任意媒体类型
- 响应首部
  - 响应报文有自己的首部集，以便为客户端提供信息，比如Server首部，用来告知客户端它在与一个什么服务器进行交互。
- 实体首部
  - 用于应对实体主体部分的首部，可以用实体首部来说明实体主体部分的数据类型，比如Content-Type首部。
- 扩展首部

### 通用首部

- Connection--允许客户端和服务器指定与请求、响应连接有关的选项
- Date--提供日期和事件标志，说明报文是什么时候创建的
- MIME-Version--给出了发送端使用的MIME版本
- Trailer--如果报文采用了分块传输编码方式，就可以用这个首部列出位于报文拖挂部分的首部结合
- Transfer-Encoding--告知接收端为了保证报文的可靠传输，对报文采用了什么编码方式
- Update--给出了发送端可能想要升级使用的新版本或协议
- Via--显示了报文经过的中间节点（代理、网关）

### 请求首部

- Client-IP--提供了运行客户端的机器的IP地址
- From--提供了客户端用户的E-mail地址
- Host--给出了接收请求的服务器的主机名和端口号
- Referer--提供了包含当前请求的URI的文档的URL
- User-Agent--将发起请求的应用程序名称告知服务

1、Accept首部

为客户端提供了一种将其喜好和能力告知服务器的方式。

- Accept--告诉服务器能够发送哪些媒体请求
- Accept-Charset--告诉服务器能够发送哪些字符集
- Accept-Encoding--告诉服务器能够发送哪些编码方式
- Accept-Language--告诉服务器能够发送哪些语言
- TE--告诉服务器可以使用哪些扩展传输编码

2、条件请求首部

客户端可以为请求加上某些限制，要求服务器在对请求进行响应之前，确保某个条件为真。

- Expect--允许客户端列出某请求所要求的服务器行为
- If-Match--如果实体标记与文档当前的实体标记相匹配，就获取这份文档
- If-Modified-Since--除非在某个指定的日期之后资源被修改过，否则就限制这个请求
- If-None-Match--如果提供的实体标记与当前文档的实体标记不符，就获取文档
- If-Range--允许对文档的某个范围进行条件请求
- If-Unmodified-Since--除非在某个指定日期之后资源没有被修改过，否则就限制这个请求
- Range--如果服务支持范围请求，就请求资源的指定范围

3、安全请求首部

客户端在获取特定资源之前，先对自身进行认证，这样就可以使事务稍微安全一些。

- Authorization--包含了客户端提供给服务器，以便对其自身进行认证的数据
- Cookie--客户端用它向服务器传送一个令牌，它并不是真正的安全首部，但却是隐含了安全功能
- Cookie2--用来说明请求端支持的cookie版本

### 响应首部

- Age--从最初创建开始，响应持续时间
- Public--服务器为其资源支持的请求方法列表
- Retry-After--如果资源不可用的话，在此日期或时间重试
- Server--服务器应用程序软件的名称和版本
- Title--对HTML文档来说，就是HTML文档的资源端给出的标题
- Warning--比原因短语中更详细一些的警告报文

1、协商首部

- Accept-Ranges--对此资源来说，服务器可接受的范围类型
- Vary--服务器查看的其它首部列表，可能会使响应发生变化

2、安全响应首部

- Proxy-Authenticate--来自代理的对客户端的质询列表
- Set-Cookie--不是真正的安全首部，但隐含有安全功能
- Set-Cookie2--与Set-Cookie类似
- WWW-Authenticate--来自服务器的对客户端的质询列表

### 实体首部

- Allow--列出了可以对此实体执行的请求方法
- Location--告知客户端实体实际上位于何处

1、内容首部

- Content-Base--解析主体2中的相对URL时使用的基础URL
- Content-Encoding--对主体执行的任意编码方式
- Content-Language--理解主体时最适宜使用的自然语言
- Content-Length--主体的长度或尺寸
- Content-Location--资源实际所处的位置
- Content-MDS--主体的MD5校验和
- Content-Range--在整个资源中此实体表示的字节范围
- Content-Type--这个主体的对象类型

2、实体缓存首部

- ETage--与此实体相关的实体标记
- Expires--实体不再有效，要从原始的源端再次获取此实体的日期和时间
- Last-Modified--这个实体最后一次被修改的日期和时间

# 连接管理

几乎所有的HTTP通信都是由TCP/IP承载的，TCP、IP是全球计算机及网络设备都在使用的一种常用的分组交换网络分层协议集。

### TCP流是分段的、由IP分组传送

TCP的数据是通过名为IP分组的小数据块来发送的。

HTTP的网络协议层：

1. HTTP（应用层）
2. TCP（传输层）
3. IP（网络层）
4. 网络接口（数据链路层）

HTTPS就是在HTTP和TCP之间加入了一个安全层，TSL或SSL。

### TCP和端口号

TCP是通过端口号来保持所有连接连续不断地运行。

TCP连接是通过4个值来识别的：

<源IP地址、源端口号、目的IP地址。目的端口号>

两条不同的TCP连接不能拥有4个完全相同的地址组件值。（HTTP权威指南 P84 图4-5）

## TCP三次握手

三次握手是为了防止服务器开启一些无用的连接，增加服务器开销以及防止已失效的连接请求报文段突然又传送到了服务器，因而产生错误。

个人理解就是：通知服务器，客户端已经接收到了服务器传输的数据，防止服务器没有收到请求而一直开启端口。

还有一种情况是防止服务器接收到已失效的客户端发出的请求信息。

总的来说就是确定两端能够正常发送以及接收数据。

### 过程

- 握手之前，两端都处于closed阶段
- 客户端主动打开连接，结束closed阶段；被动打开连接的服务器也结束closed阶段，并进入listen阶段，随后开始握手
- 客户端想服务器发送一段TCP报文，请求建立新连接
- 服务器接收到来自客户端的TCP报文，结束listen阶段并返回一段TCP报文，确认客户端报文有效，服务器能正常接收客户端发送的数据，并同意建立连接
- 客户端收到服务器的确认报文，明确客户端到服务器的数据传输是正常的，就返回最后一段报文，双方都进入established阶段，可以进行数据传输了。

## TCP四次挥手

- 挥手之前，双方都处于established阶段
- 客户端主动要求释放连接，向服务器发送一段TCP报文，并进入半关闭状态，停止向服务器发送数据，但仍能接收到服务器传来的数据
- 服务器接收到客户端传来的TCP报文，确认对方想要释放连接，就结束established阶段，进入半关闭状态并发送一段TCP报文，客户端收到TCP报文，结束fin-wait-1阶段，进入fin-wait-2阶段
- 服务器做好了释放服务器到客户端方向上的连接准备，再次向客户端发出一段TCP报文，结束close-wait阶段，进入last-ack阶段，并停止向客户端发送数据，但仍能接收到客户端发来的数据
- 客户端收到TCP报文，确认服务器已经做好释放连接的准备，结束fin-wait-2阶段，进入time-wait阶段，并发送一段报文，服务器接收到报文，进入closed阶段，客户端等待玩之后也进入到closed阶段，完成四次挥手。

