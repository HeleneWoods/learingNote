`计算机网络学习的核心内容就是网络协议的学习。`

**网络协议**是为计算机网络中进行数据交换二建立的规则、标准或者说是约定的集合。

计算机网络协议有很多种，其中由ARPA公司推出的TCP/IP标准网络协议已经成为Internet中的通用语言。

## 网络层次划分

**OSI/RM模型**：开放系统互联参考模型。

它将计算机网络体系结构的通信协议划分为七层，由上到下分别是：物理层、数据链路层、网络层、传输层、会话层、应用层。

传输层完成数据传送服务，上面三层面向用户。

除此之外，还有TCP/IP四层协议以及TCP/IP五层协议。

![层次划分对应关系](/Users/396293674qq.com/Documents/MD/learingNote/img/网络层次.png"层次划分对应关系")

## OSI七层网络模型

任何和互联网相关的操作都离不开TCP/IP协议，不管是几层模型，每一层中都要自己的专属协议。

![](/Users/396293674qq.com/Documents/MD/learingNote/img/网络模型.png)

### 物理层（Physical Layer）

该层为上层协议提供了一个传输数据的可靠的物理媒体，确保原始的数据可在各种物理媒体上传输。

物理层有两个重要的设备名称：中继器（Repeater，也叫放大器）和集线器。

### 数据链路层（Data Link Layer）

数据链路层在物理层提供的服务的基础上向网络层提供服务，将源自网络层来的数据可靠地传输到相邻节点的目标机网络层。

首先要将数据组合成数据块，也称作是`帧（frame）`，帧是链路层的传送单位。

为提供可靠的数据传输，还需要处理传输差错，调节发送速率，以及在两个网络实体之间提供数据链路通路的建立/维持和释放的管理。

两个重要设备名称：网桥和交换机。

### 网络层（Network Layer）

网络层的具体功能包括寻址、路由选择、连接的建立、保持和终止。

网络层中设计众多协议，其中最重要的就是TCP/IP的核心协议——IP协议。

IP协议的主要功能就有：无连接数据报传输、数据报路由选择和差错控制。

与IP协议配套使用实现其功能的还有：地址解析协议ARP、逆地址解析协议RARP、因特网报文协议ICMP、因特网组管理协议IGMP。

重要设备：路由器。

### 传输层（Transport Layer）

传输层负责将上层数据分段并提供端到端的、可靠或不可靠的传输，并要处理端到端的差错控制和流量控制问题。

在这一层，信息传送的协议数据单元成为`段`或`报文`。

网络层只是根据网络地址将源结点发出的数据包传送到目的结点，而传输层则负责将数据可靠地传送到相应的端口。

这一层的主要协议：TCP协议（传输控制协议）、UDP协议（用户数据报协议）。

重要设备：网关。

### 会话层

会话层管理主机之间的会话进程，即负责建立、管理、终止进程之间的会话。会话层还利用在数据中插入校验点来实现数据的同步。

### 表示层

表示层对上层数据或信息进行变换以保证一个主机应用层信息可以被另一个主机的应用程序理解。表示层的数据转换包括数据的加密、压缩、格式转换等。

### 应用层

为操作系统或网络应用程序提供访问网络服务的接口。

以上三层数据传输的基本单位为`报文`，主要协议有：FTP（文件传送协议）、Telnet（远程登录协议）、DNS（域名解析协议）、SMTP（邮件传送协议），POP3协议（邮局协议），HTTP协议（Hyper Text Transfer Protocol）。

## 各种协议

### ARP/RARP协议

**地址解析协议**：是根据IP地址获取物理地址的一个TCP/IP协议。

ARP命令可用于查询本机ARP缓存中IP地址和MAC地址的对应关系、添加或删除静态对应关系等。

发送包含目标IP地址的ARP请求的主机接收到返回信息，会将IP地址和物理地址存入本机ARP缓存中保留一段时间以节约资源。

地址解析协议是建立在网络中各个主机互相信任的基础上的，收到应答报文时不会检验该报文的真实性，并计入本机ARP内存中。

RARP，即逆地址解析协议与ARP协议相对，将局域网中某个主机的物理地址转换为IP地址。

工作流程：

- 给主机发送一个本地RARP广播，声明自己的MAC地址，并请求收到此请求的RARP服务器分配一个IP地址
- 本地网段上的RARP服务器收到此请求后检查RARP列表，查找该MAC地址对应的IP地址
- 存在就给源主机发送一个响应数据包，将IP地址提供给它使用，不存在就不做任何响应

### 路由选择协议

常见路由选择协议：RIP协议、OSPF协议。

RIP协议 ：底层是贝尔曼福特算法，它选择路由的度量标准（metric)是跳数，最大跳数是15跳，如果大于15跳，它就会丢弃数据包。

OSPF协议 ：Open Shortest Path First开放式最短路径优先，底层是迪杰斯特拉算法，是链路状态路由选择协议，它选择路由的度量标准是带宽，延迟。

### TCP/IP协议

TCP/IP协议时Internet最基本的协议、Internet国际互联网络的基础。

它由网络层的IP协议和传输层的TCP协议组成。

TCP负责发现传输的问题，一有问题就发出信号，要求重新传输，直到所有数据安全正确地传输到目的地，是面向连接的通信协议。

IP是给因特网的每一台联网设备规定一个地址，接收由更低层发来的数据包，发送到更高层；同样也接收更高层的数据包发送到更低层。

**TCP协议的三次握手和四次挥手**

![TCP三次握手和四次挥手](/Users/396293674qq.com/Documents/MD/learingNote/img/TCP握手.png"TCP三次握手和四次挥手")

**注：seq**:"sequance"序列号；**ack**:"acknowledge"确认号；**SYN**:"synchronize"请求同步标志；**；ACK**:"acknowledge"确认标志"；**FIN**："Finally"结束标志。

TCP连接过程：

- 客户端发送请求报文
- 服务器端接收连接后回复ACK报文，并为这次连接分配资源
- 客户端收到ACK报文后向服务端发生ACK报文并分配资源

TCP断开过程：

- 客户端发起终端连接到请求
- 服务端收到FIN报文后，还继续发送没有完成的数据，同时发送ACK告知服务端已经收到断开连接的请求，这时的服务端处于FIN_WAIT的状态
- 当数据全都传输完毕，服务端向客户端发送FIN报文，告知客户端已经准备好关闭连接了
- 客户端收到FIN报文，再次发送ACK确认关闭连接，服务端收到ACK后关闭服务，客户端处于TIME_WAIT状态，等了2MSL后没有收到回复就证明服务端已经关闭，客户端也正式关闭

#### 为什么是三次握手

假设只有两次握手，如果客户端在数据传输过程中因为网络并发量很大，在某节点被阻塞了，会重新发送请求，这时服务端会收到两次请求，但实际上客户端只有一次请求，而服务端却有两个响应，甚至可能出现多个响应在等待，造成服务端端资源浪费。

#### 为什么是四次挥手

双方建立了连接之后都拥有发送数据的主动权，在客户端提出断开连接时会先停止向服务端发送数据，并等待服务端的回应，而服务端在数据传输完成之前不会停止发送数据，传输完成之后终止发送数据并告知客户端已经准备好断开连接，并等到客户端的确认，收到回复后双方各自断开连接。说白了，就是因为双方处于平等的位置，需要保证合约的完整执行。

### UDP协议

用户数据报协议，是面向无连接的通讯协议，因此可以实现广播发送，是一种不可靠的传输，可能出现丢包现象，和TCP位于同一层。

UDP数据包括目的端口号和源端口号信息。

UDP一般主要用于面向查询、应答的服务，例如NFS，这种服务需要交换的信息量较小。

DNS就使用了UDP协议。

### DNS协议

DNS是域名系统（Domain Name System)，可以将URL转换为IP地址。每一个域名都对应一个唯一的IP地址，域名是IP地址的一种更友好的表达方式。

### NAT协议

网络地址转换（Network Address Translation）属接入广域网（WAN）技术，是一种将私有地址转化为合法IP地址的转换技术。